# GitHub Actions workflow for deploying OpenClaw Gateway to Google Cloud Run
#
# Required secrets:
#   GCP_PROJECT_ID: Google Cloud project ID
#   GCP_SA_KEY: Service account key JSON (base64 encoded)
#   GATEWAY_TOKEN: Gateway authentication token
#
# Optional secrets:
#   SLACK_WEBHOOK_URL: Slack webhook for deployment notifications
#
# Trigger: Push to main branch or manual dispatch

name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      region:
        description: 'Cloud Run region'
        required: true
        default: 'us-central1'
        type: choice
        options:
          - us-central1
          - us-east1
          - europe-west1
          - asia-east1

env:
  REGION: ${{ github.event.inputs.region || 'us-central1' }}
  SERVICE_NAME: openclaw-gateway
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}

jobs:
  # ============================================================================
  # Build and Test
  # ============================================================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm tsc --noEmit

      - name: Run tests
        run: pnpm test --run
        continue-on-error: true

      - name: Build
        run: pnpm build

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "image_tag=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Image tag: $SHORT_SHA"

  # ============================================================================
  # Deploy to Cloud Run
  # ============================================================================
  deploy:
    name: Deploy to Cloud Run
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io

      - name: Build Docker image
        run: |
          docker build \
            --file Dockerfile.cloudrun \
            --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ needs.build-and-test.outputs.image_tag }} \
            --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
            --cache-from gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .

      - name: Push Docker image
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ needs.build-and-test.outputs.image_tag }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ needs.build-and-test.outputs.image_tag }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --min-instances 1 \
            --max-instances 10 \
            --memory 2Gi \
            --cpu 2 \
            --timeout 3600 \
            --concurrency 80 \
            --execution-environment gen2 \
            --cpu-boost \
            --session-affinity \
            --set-env-vars "NODE_ENV=production,PORT=8080" \
            --labels "app=openclaw,component=gateway,version=${{ needs.build-and-test.outputs.image_tag }}" \
            --format "value(status.url)" | tee service_url.txt

          echo "service_url=$(cat service_url.txt)" >> $GITHUB_OUTPUT

      - name: Verify deployment health
        run: |
          SERVICE_URL=$(cat service_url.txt)
          echo "Service URL: $SERVICE_URL"
          
          # Wait for service to be ready
          sleep 10
          
          # Health check
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ Health check returned HTTP $HTTP_STATUS (may still be initializing)"
          fi

      - name: Post deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | ${{ env.SERVICE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build-and-test.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Service URL | ${{ steps.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Notify (Optional)
  # ============================================================================
  notify:
    name: Notify
    needs: [build-and-test, deploy]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Notify Slack
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "OpenClaw Gateway deployed to Cloud Run",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*OpenClaw Gateway Deployment*\nâ€¢ Status: ${{ needs.deploy.result }}\nâ€¢ Region: ${{ env.REGION }}\nâ€¢ Commit: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
